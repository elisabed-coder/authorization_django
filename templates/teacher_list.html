{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Select Subject and Teacher</title>
    <style>
        .form-error { color: red; }
        .debug-info { background: #f0f0f0; padding: 10px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>Select Your Subject and Teacher</h1>

    {% if messages %}
    <div class="messages">
        {% for message in messages %}
        <div{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</div>
        {% endfor %}
    </div>
    {% endif %}

    <form method="post" action="{% url 'user:select_teacher_subject' %}" id="teacherSelectionForm">
        {% csrf_token %}

        {% if form.non_field_errors %}
        <div class="form-error">
            {{ form.non_field_errors }}
        </div>
        {% endif %}

        <div class="form-group">
            <label for="id_subject">{{ form.subject.label }}</label>
            {{ form.subject }}
            {% if form.subject.errors %}
            <div class="form-error">{{ form.subject.errors }}</div>
            {% endif %}
        </div>

        <div class="form-group">
            <label for="id_selected_teacher">{{ form.selected_teacher.label }}</label>
            {{ form.selected_teacher }}
            {% if form.selected_teacher.errors %}
            <div class="form-error">{{ form.selected_teacher.errors }}</div>
            {% endif %}
        </div>

        <button type="submit">Save Selection</button>
    </form>

    {% if debug %}
    <div class="debug-info">
        <h3>Debug Information</h3>
        <p>Current User: {{ user.username }}</p>
        <p>Current Subject: {{ user.subject }}</p>
        <p>Form Data: {{ form.data }}</p>
        <p>selected teacher: {{ user.selected_teacher }}</p>
        <p>Form Errors: {{ form.errors }}</p>
    </div>
    {% endif %}

    <h2>Your Selected Subject</h2>

{% if user.subject %}
    <ul id="subjectList">
        <li>
            <strong>Selected Subject:</strong> {{ user.subject }}
            <button type="button" class="delete-subject-button" data-subject="{{ user.subject }}">
                Delete
            </button>
        </li>
    </ul>
{% else %}
    <p>No subject selected yet.</p>
{% endif %}

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>
    $(document).ready(function() {
        console.log('Document ready');  // Debug log

        // Add form submission handler
        $('#teacherSelectionForm').on('submit', function() {
            console.log('Form submitted');  // Debug log
        });

        // Handle subject change
        $('#id_subject').change(function() {
            let selectedSubject = $(this).val();
            console.log('Selected subject:', selectedSubject);  // Debug log

            $.ajax({
                url: "{% url 'user:get_teachers_by_subject' %}",
                data: { 'subject': selectedSubject },
                success: function(data) {
                    console.log('Received teacher data:', data);  // Debug log
                    let teacherSelect = $('#id_selected_teacher');
                    teacherSelect.empty();

                    // Add a default option
                    teacherSelect.append($('<option>', {
                        value: '',
                        text: 'Select a teacher'
                    }));

                    $.each(data, function(index, teacher) {
                        teacherSelect.append($('<option>', {
                            value: teacher.id,
                            text: teacher.username
                        }));
                    });
                },
                error: function(xhr, status, error) {
                    console.error('AJAX Error:', error);
                    console.error('Status:', status);
                    console.error('Response:', xhr.responseText);
                }
            });
        });
    });
$(document).ready(function() {
    // Handle subject deletion along with teacher deletion
    $(document).on('click', '.delete-subject-button', function() {
        let subject = $(this).data('subject');
        console.log('Deleting subject and associated teacher:', subject);  // Debug log

        $.ajax({
            url: "{% url 'user:delete_subject_selection' %}",
            type: "POST",
            data: {
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function() {
                console.log('Subject and teacher deleted successfully');
                $('#subjectList').remove();  // Remove the subject list item from the DOM
                $('#teacherList').remove();  // Remove the teacher list item from the DOM, if applicable
                location.reload();  // Reload the page to update the subject and teacher display
            },
            error: function(xhr, status, error) {
                console.error('Delete Error:', error);
                console.error('Status:', status);
                console.error('Response:', xhr.responseText);
            }
        });
    });
});

    </script>
</body>
</html>